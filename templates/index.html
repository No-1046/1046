<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>株価AI予測（日/週/月）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body class="bg-slate-950 text-slate-100">
  <div class="max-w-6xl mx-auto p-4 md:p-8">

    <header class="mb-5">
      <h1 class="text-xl md:text-2xl font-bold">📈 株価AI予測 <span id="titleName" class="text-slate-400 text-base"></span></h1>
      <div class="text-sm text-slate-400">データ: Yahoo Finance / API: FastAPI</div>
    </header>

    <!-- 検索＆設定 -->
    <section class="mb-4 grid md:grid-cols-4 gap-3">
      <div class="md:col-span-2">
        <label class="block text-sm text-slate-400 mb-1">銘柄コード（例: 6501 / 7203 / AAPL）</label>
        <input id="tickerInput" class="w-full rounded-xl bg-slate-900 border border-slate-800 px-3 py-2" value="6501" placeholder="例: 6501">
      </div>
      <div>
        <label class="block text-sm text-slate-400 mb-1">足種</label>
        <select id="frame" class="w-full rounded-xl bg-slate-900 border border-slate-800 px-3 py-2">
          <option value="1d">日足</option>
          <option value="1wk">週足</option>
          <option value="1mo">月足</option>
        </select>
      </div>
      <div>
        <label class="block text-sm text-slate-400 mb-1">Horizon（バー数）</label>
        <select id="horizon" class="w-full rounded-xl bg-slate-900 border border-slate-800 px-3 py-2">
          <option value="5">+5</option>
          <option value="10">+10</option>
          <option value="20">+20</option>
        </select>
      </div>
    </section>

    <div class="mb-3">
      <button id="searchBtn" class="rounded-xl bg-emerald-600 hover:bg-emerald-500 px-5 py-3 font-semibold">更新</button>
    </div>

    <!-- 指標カード -->
    <section class="grid grid-cols-2 gap-3 md:gap-4 mb-4">
      <div class="rounded-2xl bg-slate-900/60 border border-slate-800 p-4">
        <div class="text-sm text-slate-400 mb-1">現在値（終値）</div>
        <div id="last" class="text-2xl font-semibold">--</div>
        <div class="text-xs text-slate-500 mt-1">更新: <span id="asof">--</span></div>
      </div>
      <div class="rounded-2xl bg-slate-900/60 border border-slate-800 p-4">
        <div class="text-sm text-slate-400 mb-1">AI予測（horizon末の期待値）</div>
        <div id="pred" class="text-2xl font-semibold">--</div>
        <div class="text-sm text-slate-400 mt-2">上昇確率</div>
        <div id="prob" class="text-xl font-semibold">--%</div>
        <div class="text-xs text-slate-500 mt-1">モデル: <span id="model">--</span></div>
      </div>
    </section>

    <!-- チャート -->
    <section class="rounded-2xl bg-slate-900/60 border border-slate-800 p-3">
      <canvas id="chart" height="160"></canvas>
      <div id="status" class="text-xs text-slate-400 mt-2"></div>
    </section>

    <footer class="text-xs text-slate-500 mt-6">
      予測は将来の成果を保証しません。投資判断は自己責任でお願いします。
    </footer>
  </div>

<script>
const api = (p) => `${location.origin}/api${p}`;
let ticker = "6501";
let frame  = "1d";
let horizon = 5;
let series = [];
let chart;

function fmt(n, d=2){ return Number(n).toFixed(d); }
function fmtP(n){ return (Number(n)*100).toFixed(1) + "%"; }

function monthTickLabels(rows){
  const labels = [];
  let prev = "";
  for(const r of rows){
    if (r.xm !== prev){
      labels.push(r.xm);
      prev = r.xm;
    } else {
      labels.push("");
    }
  }
  return labels;
}

async function loadSeries(years=10){
  const url = api(`/series?ticker=${encodeURIComponent(ticker)}&frame=${frame}&years=${years}`);
  const status = document.getElementById("status");
  try{
    const res = await fetch(url);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const j = await res.json();
    series = j.rows;
    document.getElementById("titleName").textContent = `（${j.name} / ${j.ticker}）`;
    status.textContent = `取得: ${series.length}本 / ${j.ticker} / ${frame}`;
  }catch(e){
    status.textContent = "データ取得に失敗: " + e.message;
    series = [];
    document.getElementById("titleName").textContent = "";
  }
}

function drawChart(predClose=null){
  const close = series.map(r=>r.c);
  const labels = monthTickLabels(series);
  const datasets = [{
    label: "終値",
    data: close,
    borderWidth: 2,
    tension: 0.2,
    pointRadius: 0
  }];
  if (predClose != null && close.length){
    datasets.push({
      label: "予測",
      data: [...Array(close.length-1).fill(null), close.at(-1), predClose],
      borderDash: [6,4], borderWidth: 2, pointRadius: 3
    });
  }
  if (chart) chart.destroy();
  chart = new Chart(document.getElementById("chart"), {
    type: "line",
    data: { labels, datasets },
    options: {
      plugins: { legend: { display: false }},
      scales: {
        x: { grid: { color: "rgba(148,163,184,0.15)" }, ticks: { color:"#cbd5e1" } },
        y: { grid: { color: "rgba(148,163,184,0.15)" }, ticks: { color:"#cbd5e1" } }
      }
    }
  });
}

async function loadPredict(){
  const url = api(`/predict?ticker=${encodeURIComponent(ticker)}&frame=${frame}&years=10&horizon=${horizon}`);
  const status = document.getElementById("status");
  try{
    const r = await fetch(url);
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const j = await r.json();

    document.getElementById("titleName").textContent = `（${j.name} / ${j.ticker}）`;
    document.getElementById("last").textContent  = fmt(j.last_close, 2);
    document.getElementById("asof").textContent  = j.asof;
    document.getElementById("pred").textContent  = fmt(j.pred_close, 2);
    document.getElementById("prob").textContent  = fmt(j.prob_up);
    document.getElementById("model").textContent = j.model;

    drawChart(j.pred_close);
  }catch(e){
    status.textContent = "予測取得に失敗: " + e.message;
    drawChart(null);
  }
}

async function refreshAll(){
  await loadSeries();
  await loadPredict();
}

// UI handlers
document.getElementById("searchBtn").addEventListener("click", refreshAll);
document.getElementById("tickerInput").addEventListener("keydown", (e)=>{
  if(e.key==="Enter") refreshAll();
});
document.getElementById("tickerInput").addEventListener("change", (e)=>{
  ticker = e.target.value.trim();
});
document.getElementById("frame").addEventListener("change", (e)=>{
  frame = e.target.value;
});
document.getElementById("horizon").addEventListener("change", (e)=>{
  horizon = Number(e.target.value);
});

(async function boot(){
  await refreshAll();
})();
</script>
</body>
</html>
